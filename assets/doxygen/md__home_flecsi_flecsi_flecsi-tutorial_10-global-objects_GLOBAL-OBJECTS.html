<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" type="image/x-icon" href="flecsi-favicon.ico" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<title>Interface Documentation: FleCSI: Tutorial - 10 Global Objects</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" height="200" style="margin-top:40px; margin-left:30px; margin-right:10px" src="medium-flecsi.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Interface Documentation<br>
		<span id="projectnumber">Version:</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">FleCSI: Tutorial - 10 Global Objects </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Global Objects</h1>
<p><span style="color:red"> <em>Advanced Topic: Intended for Specialization Developers</em> </span></p>
<p>The data model enforced by the FleCSI runtime makes it illegal to implement traditional C++ object models that employ dynamic polymorphism. In general, you are not allowed to register data types with the runtime that use virtual tables, i.e., the FleCSI data model does not allow virtual or pure virtual types. Experimentation with various application projects has shown that virtual inheritance is a useful design pattern for certain dynamic data needs. The FleCSI global object interface provides a mechanism to allow some of these patterns, provided that they follow particular initialization and usage rules.</p>
<p><em>NOTE: The restriction on dynamic polymorphism arises from the possibility that data that are registered with the FleCSI runtime may be mapped or moved to multiple memory spaces during the execution of a program. These operations would invalidate the virtual method table (VMT) used to support dynamic dispatch (runtime binding), making the interface invalid.</em></p>
<p>One pattern of dynamic polymorphism that is safe involves object instances that are created during an initialization phase on each logical color of a distributed-memory program. In this case, each unit of execution (color) must execute the same steps. This allows us to reason about what execution path has taken place, regardless of how the processes have been mapped to node resources. Using this reasoning, FleCSI can support a global object interface that allows users to register dynamically polymorphic types with the runtime. These can then be initialized during an appropriate phase of execution, and are available during task execution. The types themselves may have any legal C++ interface, and they are not restricted by the general data model rules of FleCSI. The FleCSI global object interface has three methods: <em>flecsi_register_global_object</em>, <em>flecsi_initialize_global_object</em>, and <em>flecsi_get_global_object</em>.</p>
<p>The registration interface takes the following arguments:</p>
<ol type="1">
<li>The name of the global object instance (user-defined). In this example, the names are <em>type_1</em> and <em>type_2</em>. The name is used as an identifier for subsequent calls to the interface. In this example, the identifier is actually an enumerated type value. This is useful if the user wants to switch over various derived types using only an integer id.</li>
<li>The namespace of the object instance (user-defined). This is used to avoid naming collisions. In this example, the namespace is <em>derived</em>.</li>
<li>The base class type of the global object instance. This must be a valid C++ type. In this example, the base class is <em><a class="el" href="structbase__t.html">base_t</a></em>.</li>
</ol>
<p>The initialization interface takes the following arguments:</p>
<ol type="1">
<li>The name of the global object instance.</li>
<li>The namespace of the object instance.</li>
<li>The type with which the object should be initialized. In general, this is a derived type. Initialization will instantiate a new object of this type.</li>
<li>A variadic argument list that will be passed to the constructor of the type argument.</li>
</ol>
<p>The get interface takes the following arguments:</p>
<ol type="1">
<li>The name of the global object instance.</li>
<li>The namespace of the object instance.</li>
<li>The base class type of the global object instance. This must be a valid C++ type. In this example, the base class is <em><a class="el" href="structbase__t.html">base_t</a></em>.</li>
</ol>
<p>NOTES:</p>
<ul>
<li>It is currently only possible to set global objects in a specialization initialization control point. This is intended to avoid possible race conditions. This restriction may be relaxed in future versions.</li>
<li>Global object instances are managed by the runtime, e.g., the destructor will be called for each global object that is registered.</li>
</ul>
<p>The code for this example can be found in <em>global-objects.cc</em>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cstdlib&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include&lt;flecsi-tutorial/specialization/mesh/mesh.h&gt;</span></div><div class="line"><span class="preprocessor">#include&lt;<a class="code" href="data_8h.html">flecsi/data/data.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include&lt;<a class="code" href="execution_8h.html">flecsi/execution/execution.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceflecsi.html">flecsi</a>;</div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceflecsi_1_1tutorial.html">flecsi::tutorial</a>;</div><div class="line"></div><div class="line"><span class="comment">// Create an identifier type. This will allow us to switch between</span></div><div class="line"><span class="comment">// object instances using an integer id.</span></div><div class="line"></div><div class="line"><span class="keyword">enum</span> identifier_t : <span class="keywordtype">size_t</span> {</div><div class="line">  type_1,</div><div class="line">  type_2</div><div class="line">}; <span class="comment">// enum identifier_t</span></div><div class="line"></div><div class="line"><span class="comment">// Create a data type to store the integer id.</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="structdata__t.html">data_t</a> {</div><div class="line">  identifier_t id;</div><div class="line">}; <span class="comment">// struct data_t</span></div><div class="line"></div><div class="line"><span class="comment">// Define an accessor type to use as the task argument.</span></div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;</div><div class="line"><span class="keywordtype">size_t</span> SHARED_PRIVILEGES&gt;</div><div class="line"><span class="keyword">using</span> cell_data = <a class="code" href="structflecsi_1_1accessor_____3_01data_1_1dense_00_01T_00_01EXCLUSIVE__PERMISSIONS_00_01SHARED__Pe927e95b5549d371feaf66e9ea26f6d3.html">dense_accessor&lt;data_t, rw, SHARED_PRIVILEGES, ro&gt;</a>;</div><div class="line"></div><div class="line"><span class="comment">// This is a simple base type with one pure virtual method that we will</span></div><div class="line"><span class="comment">// use to demonstrate the global object interface.</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="structbase__t.html">base_t</a> {</div><div class="line">  <span class="keyword">virtual</span> ~<a class="code" href="structbase__t.html">base_t</a>() { std::cout &lt;&lt; <span class="stringliteral">&quot;delete called&quot;</span> &lt;&lt; std::endl; }</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> compute(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y) = 0;</div><div class="line"></div><div class="line">}; <span class="comment">// struct base_t</span></div><div class="line"></div><div class="line"><span class="comment">// A derived type with a non-trivial constructor.</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="structtype__1__t.html">type_1_t</a> : <span class="keyword">public</span> <a class="code" href="structbase__t.html">base_t</a> {</div><div class="line"></div><div class="line">  <a class="code" href="structtype__1__t.html">type_1_t</a>(<span class="keywordtype">double</span> w0, <span class="keywordtype">double</span> w1)</div><div class="line">    : w0_(w0), w1_(w1) {}</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> compute(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y)<span class="keyword"> override </span>{</div><div class="line">    <span class="keywordflow">return</span> w0_*x + w1_*y;</div><div class="line">  } <span class="comment">// compute</span></div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> w0_;</div><div class="line">  <span class="keywordtype">double</span> w1_;</div><div class="line"></div><div class="line">}; <span class="comment">// struct type_1_t</span></div><div class="line"></div><div class="line"><span class="comment">// A derived type with a trivial constructor.</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="structtype__2__t.html">type_2_t</a> : <span class="keyword">public</span> <a class="code" href="structbase__t.html">base_t</a> {</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> compute(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y)<span class="keyword"> override </span>{</div><div class="line">    <span class="keywordflow">return</span> x*y;</div><div class="line">  } <span class="comment">// compute</span></div><div class="line"></div><div class="line">}; <span class="comment">// struct type_2_t</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceexample.html">example</a> {</div><div class="line"></div><div class="line"><span class="comment">// Define a task to initialize the cell data. This will randomly pick</span></div><div class="line"><span class="comment">// one of the integer ids for each cell.</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> update(<a class="code" href="structflecsi_1_1data__client__handle__base____.html">mesh&lt;ro&gt;</a> m, <a class="code" href="structflecsi_1_1accessor_____3_01data_1_1dense_00_01T_00_01EXCLUSIVE__PERMISSIONS_00_01SHARED__Pe927e95b5549d371feaf66e9ea26f6d3.html">cell_data&lt;rw&gt;</a> cd) {</div><div class="line">  <span class="keywordflow">for</span>(<span class="keyword">auto</span> c: m.cells(owned)) {</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> flip = double(rand())/RAND_MAX + 0.5;</div><div class="line">    cd(c).id = flip ? type_1 : type_2;</div><div class="line">  } <span class="comment">// for</span></div><div class="line">} <span class="comment">// update</span></div><div class="line"></div><div class="line"><a class="code" href="group__execution.html#ga4dcd75ac370388c816b99672d589c4bc">flecsi_register_task</a>(update, <a class="code" href="namespaceexample.html">example</a>, loc, single);</div><div class="line"></div><div class="line"><span class="comment">// Print the results of executing the &quot;compute&quot; method.</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="simple__id_8h.html#acbc08cdd32abc7a529b2005c2bb7df42">print</a>(<a class="code" href="structflecsi_1_1data__client__handle__base____.html">mesh&lt;ro&gt;</a> m, <a class="code" href="structflecsi_1_1accessor_____3_01data_1_1dense_00_01T_00_01EXCLUSIVE__PERMISSIONS_00_01SHARED__Pe927e95b5549d371feaf66e9ea26f6d3.html">cell_data&lt;ro&gt;</a> cd) {</div><div class="line">  <span class="keywordflow">for</span>(<span class="keyword">auto</span> c: m.cells(owned)) {</div><div class="line"></div><div class="line">    <span class="comment">// This call gets the global object associated with the id we</span></div><div class="line">    <span class="comment">// randomly set in the update task.</span></div><div class="line"></div><div class="line">    <span class="keyword">auto</span> derived = <a class="code" href="group__execution.html#gacb1635615dcaaf3dc633ce0c286da42d">flecsi_get_global_object</a>(cd(c).<span class="keywordtype">id</span>, derived, <a class="code" href="structbase__t.html">base_t</a>);</div><div class="line"></div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;compute: &quot;</span> &lt;&lt; derived-&gt;compute(5.0, 1.0) &lt;&lt; std::endl;</div><div class="line">  } <span class="comment">// for</span></div><div class="line">} <span class="comment">// print</span></div><div class="line"></div><div class="line"><a class="code" href="group__execution.html#ga4dcd75ac370388c816b99672d589c4bc">flecsi_register_task</a>(print, <a class="code" href="namespaceexample.html">example</a>, loc, single);</div><div class="line"></div><div class="line">} <span class="comment">// namespace example</span></div><div class="line"></div><div class="line"><span class="comment">// Normal registration of the data client and cell data.</span></div><div class="line"></div><div class="line"><a class="code" href="group__data.html#gaaa855ccd1c709526c76247bce774ff64">flecsi_register_data_client</a>(<a class="code" href="structflecsi_1_1tutorial_1_1specialization__mesh__t.html">mesh_t</a>, clients, mesh);</div><div class="line"><a class="code" href="group__data.html#ga94367ffbedff524f08ddef3a27df2b36">flecsi_register_field</a>(<a class="code" href="structflecsi_1_1tutorial_1_1specialization__mesh__t.html">mesh_t</a>, <a class="code" href="namespaceexample.html">example</a>, cell_data,</div><div class="line">  <a class="code" href="structdata__t.html">data_t</a>, dense, 1, cells);</div><div class="line"></div><div class="line"><span class="comment">// Register the derived object instances that we will initialize and</span></div><div class="line"><span class="comment">// use in the example.</span></div><div class="line"></div><div class="line"><a class="code" href="group__execution.html#ga54a9a7044278974adfe8099ec48430b1">flecsi_register_global_object</a>(type_1, derived, <a class="code" href="structbase__t.html">base_t</a>);</div><div class="line"><a class="code" href="group__execution.html#ga54a9a7044278974adfe8099ec48430b1">flecsi_register_global_object</a>(type_2, derived, <a class="code" href="structbase__t.html">base_t</a>);</div><div class="line"></div><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceflecsi.html">flecsi</a> {</div><div class="line"><span class="keyword">namespace </span>execution {</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="hpx_2runtime__driver_8h.html#a529faee76b6bf740ce1a013919b3654f">driver</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv) {</div><div class="line"></div><div class="line">  <span class="comment">// Initialization of the object instances. In a real code, this would</span></div><div class="line">  <span class="comment">// need to occur in the specialization initialization control point.</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// Notice that the interface call accepts a variadic argument list</span></div><div class="line">  <span class="comment">// that is passed to the constructor of the particular type.</span></div><div class="line"></div><div class="line">  <a class="code" href="group__execution.html#ga59561d5f783301bac5d25190bfe1bd95">flecsi_initialize_global_object</a>(type_1, derived, <a class="code" href="structtype__1__t.html">type_1_t</a>, 1.0, 2.0);</div><div class="line">  <a class="code" href="group__execution.html#ga59561d5f783301bac5d25190bfe1bd95">flecsi_initialize_global_object</a>(type_2, derived, <a class="code" href="structtype__2__t.html">type_2_t</a>);</div><div class="line"></div><div class="line">  <span class="comment">// Get client and data handles as usual.</span></div><div class="line"></div><div class="line">  <span class="keyword">auto</span> m = <a class="code" href="group__data.html#ga9673dfe687ab0a65683d20689bd9cc46">flecsi_get_client_handle</a>(<a class="code" href="structflecsi_1_1tutorial_1_1specialization__mesh__t.html">mesh_t</a>, clients, mesh);</div><div class="line">  <span class="keyword">auto</span> cd = <a class="code" href="group__data.html#gaa8a47aa981f998c81433eece3206e5f0">flecsi_get_handle</a>(m, <a class="code" href="namespaceexample.html">example</a>, cell_data, <a class="code" href="structdata__t.html">data_t</a>, dense, 0);</div><div class="line"></div><div class="line">  <span class="comment">// Execute the tasks.</span></div><div class="line"></div><div class="line">  <a class="code" href="group__execution.html#gafca967e833f6d2dffd7d326c5993964f">flecsi_execute_task</a>(update, <a class="code" href="namespaceexample.html">example</a>, single, m, cd);</div><div class="line">  <a class="code" href="group__execution.html#gafca967e833f6d2dffd7d326c5993964f">flecsi_execute_task</a>(print, <a class="code" href="namespaceexample.html">example</a>, single, m, cd);</div><div class="line"></div><div class="line">} <span class="comment">// driver</span></div><div class="line"></div><div class="line">} <span class="comment">// namespace execution</span></div><div class="line">} <span class="comment">// namespace flecsi</span></div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
