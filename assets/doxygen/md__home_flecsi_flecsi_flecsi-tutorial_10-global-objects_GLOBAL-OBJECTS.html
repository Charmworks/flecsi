<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" type="image/x-icon" href="flecsi-favicon.ico" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Interface Documentation: FleCSI: Tutorial - 10 Global Objects</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" height="200" style="margin-top:40px; margin-left:30px; margin-right:10px" src="medium-flecsi.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Interface Documentation<br>
		<span id="projectnumber">Version:</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">FleCSI: Tutorial - 10 Global Objects </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Global Objects</h1>
<p><span style="color:red"> <em>Advanced Topic: Intended for Specialization Developers</em> </span></p>
<p>The data model enforced by the FleCSI runtime makes it illegal to implement traditional C++ object models that employ dynamic polymorphism. In general, you are not allowed to register data types with the runtime that use virtual tables, i.e., the FleCSI data model does not allow virtual or pure virtual types. Experimentation with various application projects has shown that virtual inheritance is a useful design pattern for certain dynamic data needs. The FleCSI global object interface provides a mechanism to allow some of these patterns, provided that they follow particular initialization and usage rules.</p>
<p><em>NOTE: The restriction on dynamic polymorphism arises from the possibility that data that are registered with the FleCSI runtime may be mapped or moved to multiple memory spaces during the execution of a program. These operations would invalidate the virtual method table (VMT) used to support dynamic dispatch (runtime binding), making the interface invalid.</em></p>
<p>One pattern of dynamic polymorphism that is safe involves object instances that are created during an initialization phase on each logical color of a distributed-memory program. In this case, each unit of execution (color) must execute the same steps. This allows us to reason about what execution path has taken place, regardless of how the processes have been mapped to node resources. Using this reasoning, FleCSI can support a global object interface that allows users to register dynamically polymorphic types with the runtime. These can then be set during an appropriate phase of execution, and are available during task execution. The types themselves may have any legal C++ interface, and they are not restricted by the general data model rules of FleCSI. The FleCSI global object interface has three methods: <em>flecsi_register_global_object</em>, <em>flecsi_set_global_object</em>, and <em>flecsi_get_global_object</em>.</p>
<p>The registration interface takes the following arguments:</p>
<ol type="1">
<li>The name of the global object instance (user-defined). In this example, the names are <em>type_1</em> and <em>type_2</em>. The name is used as an identifier for subsequent calls to the interface. In this example, the identifier is actually an enumerated type value. This is useful if the user wants to switch over various derived types using only an integer id.</li>
<li>The namespace of the object instance (user-defined). This is used to avoid naming collisions. In this example, the namespace is <em>derived</em>.</li>
<li>The base class type of the global object instance. This must be a valid C++ type. In this example, the base class is <em><a class="el" href="structbase__t.html">base_t</a></em>.</li>
</ol>
<p>The set interface takes the following arguments:</p>
<ol type="1">
<li>The name of the global object instance.</li>
<li>The namespace of the object instance.</li>
<li>A pointer to the allocated object instance.</li>
</ol>
<p>The get interface takes the following arguments:</p>
<ol type="1">
<li>The name of the global object instance.</li>
<li>The namespace of the object instance.</li>
<li>The base class type of the global object instance. This must be a valid C++ type. In this example, the base class is <em><a class="el" href="structbase__t.html">base_t</a></em>.</li>
</ol>
<p>NOTES:</p>
<ul>
<li>It is currently only possible to set global objects in a specialization initialization control point. This is intended to avoid possible race conditions. This restriction may be relaxed in future versions.</li>
</ul>
<p>The code for this example can be found in <em>global-objects.cc</em>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cstdlib&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include&lt;flecsi-tutorial/specialization/mesh/mesh.h&gt;</span></div><div class="line"><span class="preprocessor">#include&lt;<a class="code" href="data_8h.html">flecsi/data/data.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include&lt;<a class="code" href="execution_8h.html">flecsi/execution/execution.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceflecsi.html">flecsi</a>;</div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceflecsi_1_1tutorial.html">flecsi::tutorial</a>;</div><div class="line"></div><div class="line"><span class="keyword">enum</span> identifier_t : <span class="keywordtype">size_t</span> {</div><div class="line">  type_1,</div><div class="line">  type_2</div><div class="line">}; <span class="comment">// enum identifier_t</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="structdata__t.html">data_t</a> {</div><div class="line">  identifier_t id;</div><div class="line">}; <span class="comment">// struct data_t</span></div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;</div><div class="line"><span class="keywordtype">size_t</span> SHARED_PRIVILEGES&gt;</div><div class="line"><span class="keyword">using</span> <a class="code" href="structflecsi_1_1accessor_____3_01data_1_1dense_00_01T_00_01EXCLUSIVE__PERMISSIONS_00_01SHARED__Pe927e95b5549d371feaf66e9ea26f6d3.html">cell_data</a> = <a class="code" href="structflecsi_1_1accessor_____3_01data_1_1dense_00_01T_00_01EXCLUSIVE__PERMISSIONS_00_01SHARED__Pe927e95b5549d371feaf66e9ea26f6d3.html">dense_accessor&lt;data_t, rw, SHARED_PRIVILEGES, ro&gt;</a>;</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="structbase__t.html">base_t</a> {</div><div class="line">  <span class="keyword">virtual</span> ~<a class="code" href="structbase__t.html">base_t</a>() {}</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> compute(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y) = 0;</div><div class="line">}; <span class="comment">// struct base_t</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="structtype__1__t.html">type_1_t</a> : <span class="keyword">public</span> <a class="code" href="structbase__t.html">base_t</a> {</div><div class="line"></div><div class="line">  <a class="code" href="structtype__1__t.html">type_1_t</a>(<span class="keywordtype">double</span> w0, <span class="keywordtype">double</span> w1)</div><div class="line">    : w0_(w0), w1_(w1) {}</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> compute(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y)<span class="keyword"> override </span>{</div><div class="line">    <span class="keywordflow">return</span> w0_*x + w1_*y;</div><div class="line">  } <span class="comment">// compute</span></div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> w0_;</div><div class="line">  <span class="keywordtype">double</span> w1_;</div><div class="line"></div><div class="line">}; <span class="comment">// struct type_1_t</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="structtype__2__t.html">type_2_t</a> : <span class="keyword">public</span> <a class="code" href="structbase__t.html">base_t</a> {</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> compute(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y)<span class="keyword"> override </span>{</div><div class="line">    <span class="keywordflow">return</span> x*y;</div><div class="line">  } <span class="comment">// compute</span></div><div class="line"></div><div class="line">}; <span class="comment">// struct type_2_t</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceexample.html">example</a> {</div><div class="line"></div><div class="line"><span class="comment">// Define a task to initialize the cell data</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> update(<a class="code" href="structflecsi_1_1data__client__handle__base____.html">mesh&lt;ro&gt;</a> m, <a class="code" href="structflecsi_1_1accessor_____3_01data_1_1dense_00_01T_00_01EXCLUSIVE__PERMISSIONS_00_01SHARED__Pe927e95b5549d371feaf66e9ea26f6d3.html">cell_data&lt;rw&gt;</a> cd) {</div><div class="line">  <span class="keywordflow">for</span>(<span class="keyword">auto</span> c: m.cells(owned)) {</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> flip = double(rand())/RAND_MAX + 0.5;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(flip) {</div><div class="line">      cd(c).id = type_1;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> {</div><div class="line">      cd(c).id = type_2;</div><div class="line">    } <span class="comment">// if</span></div><div class="line">  } <span class="comment">// for</span></div><div class="line">} <span class="comment">// update</span></div><div class="line"></div><div class="line"><a class="code" href="group__execution.html#ga4dcd75ac370388c816b99672d589c4bc">flecsi_register_task</a>(update, <a class="code" href="namespaceexample.html">example</a>, loc, single);</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> print(<a class="code" href="structflecsi_1_1data__client__handle__base____.html">mesh&lt;ro&gt;</a> m, <a class="code" href="structflecsi_1_1accessor_____3_01data_1_1dense_00_01T_00_01EXCLUSIVE__PERMISSIONS_00_01SHARED__Pe927e95b5549d371feaf66e9ea26f6d3.html">cell_data&lt;ro&gt;</a> cd) {</div><div class="line">  <span class="keywordflow">for</span>(<span class="keyword">auto</span> c: m.cells(owned)) {</div><div class="line">    <span class="keyword">auto</span> derived = <a class="code" href="group__execution.html#gacb1635615dcaaf3dc633ce0c286da42d">flecsi_get_global_object</a>(cd(c).<span class="keywordtype">id</span>, derived, <a class="code" href="structbase__t.html">base_t</a>);</div><div class="line"></div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;compute: &quot;</span> &lt;&lt; derived-&gt;compute(1.0, 1.0) &lt;&lt; std::endl;</div><div class="line">  } <span class="comment">// for</span></div><div class="line">} <span class="comment">// print</span></div><div class="line"></div><div class="line"><a class="code" href="group__execution.html#ga4dcd75ac370388c816b99672d589c4bc">flecsi_register_task</a>(print, <a class="code" href="namespaceexample.html">example</a>, loc, single);</div><div class="line"></div><div class="line">} <span class="comment">// namespace example</span></div><div class="line"></div><div class="line"><a class="code" href="group__data.html#gaaa855ccd1c709526c76247bce774ff64">flecsi_register_data_client</a>(<a class="code" href="structflecsi_1_1tutorial_1_1specialization__mesh__t.html">mesh_t</a>, clients, mesh);</div><div class="line"><a class="code" href="group__data.html#ga94367ffbedff524f08ddef3a27df2b36">flecsi_register_field</a>(<a class="code" href="structflecsi_1_1tutorial_1_1specialization__mesh__t.html">mesh_t</a>, <a class="code" href="namespaceexample.html">example</a>, cell_data,</div><div class="line">  <a class="code" href="structdata__t.html">data_t</a>, dense, 1, cells);</div><div class="line"></div><div class="line"><a class="code" href="group__execution.html#ga54a9a7044278974adfe8099ec48430b1">flecsi_register_global_object</a>(type_1, derived, <a class="code" href="structbase__t.html">base_t</a>);</div><div class="line"><a class="code" href="group__execution.html#ga54a9a7044278974adfe8099ec48430b1">flecsi_register_global_object</a>(type_2, derived, <a class="code" href="structbase__t.html">base_t</a>);</div><div class="line"></div><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceflecsi.html">flecsi</a> {</div><div class="line"><span class="keyword">namespace </span>execution {</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="hpx_2runtime__driver_8h.html#a529faee76b6bf740ce1a013919b3654f">driver</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv) {</div><div class="line"></div><div class="line">  <span class="comment">// This should move into the specialization</span></div><div class="line">  <a class="code" href="group__execution.html#gab8d25e256b30b2206f534da1415fad0e">flecsi_set_global_object</a>(type_1, derived, <a class="code" href="structbase__t.html">base_t</a>, <span class="keyword">new</span> <a class="code" href="structtype__1__t.html">type_1_t</a>(1.0, 2.0));</div><div class="line">  <a class="code" href="group__execution.html#gab8d25e256b30b2206f534da1415fad0e">flecsi_set_global_object</a>(type_2, derived, <a class="code" href="structbase__t.html">base_t</a>, <span class="keyword">new</span> <a class="code" href="structtype__1__t.html">type_1_t</a>(3.0, 4.0));</div><div class="line"></div><div class="line">  <span class="keyword">auto</span> m = <a class="code" href="group__data.html#ga9673dfe687ab0a65683d20689bd9cc46">flecsi_get_client_handle</a>(<a class="code" href="structflecsi_1_1tutorial_1_1specialization__mesh__t.html">mesh_t</a>, clients, mesh);</div><div class="line">  <span class="keyword">auto</span> cd = <a class="code" href="group__data.html#ga7e528276b2480bd22509e4afd6772bdd">flecsi_get_handle</a>(m, <a class="code" href="namespaceexample.html">example</a>, cell_data, <a class="code" href="structdata__t.html">data_t</a>, dense, 0);</div><div class="line"></div><div class="line">  <a class="code" href="group__execution.html#gafca967e833f6d2dffd7d326c5993964f">flecsi_execute_task</a>(update, <a class="code" href="namespaceexample.html">example</a>, single, m, cd);</div><div class="line">  <a class="code" href="group__execution.html#gafca967e833f6d2dffd7d326c5993964f">flecsi_execute_task</a>(print, <a class="code" href="namespaceexample.html">example</a>, single, m, cd);</div><div class="line"></div><div class="line">} <span class="comment">// driver</span></div><div class="line"></div><div class="line">} <span class="comment">// namespace execution</span></div><div class="line">} <span class="comment">// namespace flecsi</span></div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
